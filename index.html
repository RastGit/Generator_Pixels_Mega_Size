<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>8GB Stream BMP</title>
<style>
body{background:#111;color:#eee;font-family:sans-serif;padding:20px}
#bar{width:100%;height:24px;background:#333;border-radius:6px;overflow:hidden}
#prog{height:100%;width:0%;background:#4caf50}
canvas{border:1px solid #444;margin-top:10px;max-width:600px}
</style>
</head>
<body>

<h3>Generator 8GB BMP (strumieniowy)</h3>
<button onclick="start()">Start</button>
<div id="bar"><div id="prog"></div></div>
<div id="txt">0%</div>
<canvas id="preview" width="512" height="512"></canvas>

<script>
const QW = 32768;
const QH = 21845;
const W = QW*2;
const H = QH*2;

const preview = document.getElementById("preview");
const pctx = preview.getContext("2d");

function stride(w){
  const raw=w*3;
  return raw + ((4-(raw%4))%4);
}

function rand(){return Math.floor(Math.random()*256)}

async function start(){
  const handle = await showSaveFilePicker({suggestedName:"mega_8gb.bmp"});
  const file = await handle.createWritable();

  const s = stride(W);
  const size = 54 + s*H;

  const header=new Uint8Array(54);
  header[0]=0x42;header[1]=0x4D;
  new DataView(header.buffer).setUint32(2,size,true);
  new DataView(header.buffer).setUint32(10,54,true);
  new DataView(header.buffer).setUint32(14,40,true);
  new DataView(header.buffer).setUint32(18,W,true);
  new DataView(header.buffer).setUint32(22,H,true);
  header[26]=1;header[28]=24;

  await file.write(header);

  const pad=new Uint8Array(s-W*3);

  for(let y=0;y<H;y++){
    const row=new Uint8Array(W*3);

    for(let x=0;x<W;x++){
      let r=rand(),g=rand(),b=rand();
      const i=x*3;
      row[i]=b;row[i+1]=g;row[i+2]=r;
    }

    await file.write(row);
    await file.write(pad);

    if(y%200===0){
      const pct=((y/H)*100).toFixed(2);
      document.getElementById("prog").style.width=pct+"%";
      document.getElementById("txt").textContent=pct+"%";

      const img=pctx.createImageData(512,1);
      for(let i=0;i<512;i++){
        img.data[i*4]=row[i*3+2];
        img.data[i*4+1]=row[i*3+1];
        img.data[i*4+2]=row[i*3];
        img.data[i*4+3]=255;
      }
      pctx.putImageData(img,0,y%512);

      await new Promise(r=>setTimeout(r,0));
    }
  }

  await file.close();
  alert("Zapis zako≈Ñczony");
}
</script>
</body>
</html>
